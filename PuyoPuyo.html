<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <title>PuyoPuyo</title>
    <script>
    var ctx = null;

    var clic = { x: 0, y: 0 };

    /**
    *Les constantes, les variables et les structures de PuyoPuyo
    */
    var tomber = false;
    var colorVide = "#FFFFFF";
    var colorBlock = "#B5351A";
    var dir = {x:0, y:0};
    var cln = 14;
    var lgn = 8;
    var score = 0; //score du joueur
    var detection = true; //met fin à la destruction des puyos dans le jeu
    var chaine = 0; //compte le nombre de chaine pour le score
    var puyo; //tableau de jeu
    var speed = 10;
    var tabColor = ["#FF0000" /*rouge*/, "#00FF00" /*vert*/, "#0000FF" /*bleu*/, "#FF00FF" /*violet*/, "#FFFF00" /*jaune*/];
    var puyo = [];
    var timer ;
    var legroupe;
    var suite = 0;
    /**
    *objet puyo
    */

    function majPuyo(newP,oldP,lepuyo){
        puyo[newP.x][newP.y] = lepuyo;
        puyo[newP.x][newP.y].pos = newP;
        puyo[oldP.x][oldP.y] = "Vide";
        if(lepuyo.group != -1){
            leGroupe.tbGr[lepuyo.group] = lepuyo;
        }
    }

    function Block(){
        this.type = "Block";
    }

    function Puyo(i,j, inGroup=-1){
        this.type = "Puyo";
        this.color = newPuyoColor();
        this.group = inGroup;
        this.check = false;
        this.pos = {x:i, y:j};
        this.newPos = function(i,j){
            majPuyo({x:i, y:j},this.pos,this);
        }
        this.fall = function(){
            if(this.basT()){
                tomber = true;
                this.bas();
            }
        }


        this.droite = function(){
            this.newPos(this.pos.x +1, this.pos.y);
        }
        this.gauche = function(){
            this.newPos(this.pos.x -1, this.pos.y);
        }
        this.haut = function(){
            this.newPos(this.pos.x,this.pos.y-1);
        }
        this.bas = function(){
            this.newPos(this.pos.x,this.pos.y+1);
        }



        this.droiteT = function(){
            if (puyo[this.pos.x +1][this.pos.y] == "Vide"){
                return true;
            }
            return false;
        }
        this.gaucheT = function(){
            if (puyo[this.pos.x -1][this.pos.y] == "Vide"){
                return true;
            }
            return false;
        }
        this.hautT = function(){
            if (puyo[this.pos.x][this.pos.y-1] == "Vide"){
                return true;
            }
            return false;
        }
        this.basT = function(){
            if (puyo[this.pos.x][this.pos.y+1] == "Vide"){
                return true;
            }
            return false;
        }

    }


    function GroupeJoueur(){
        this.type = "groupe";
        this.rotation = 0;
        puyo[3][0] = new Puyo(3,0,0);
        puyo[4][0] = new Puyo(4,0,1);
        this.tbGr = [puyo[3][0],puyo[4][0]];
        this.go = function(direction, i=0, j=1){
            if(this.rotation >= 2){
                i=1;
                j=0
            };
            switch (direction) {
                case "droite":
                    if(this.tbGr[j].droiteT()){
                        this.tbGr[j].droite();
                        this.tbGr[i].droite();
                    }
                    break;
                case "gauche":

                    if(this.tbGr[i].gaucheT()){
                        this.tbGr[i].gauche();
                        this.tbGr[j].gauche();
                    }
                    break;

                case "bas":
                    this.enBas(i,j);
                    break;
            }
        }

        this.pivoter = function(i,j){
            switch (this.rotation) {
                case 0:
                    if(this.tbGr[i].basT() && this.tbGr[j].basT()){
                        this.tbGr[j].bas();
                        this.tbGr[j].gauche();
                        this.rotation = 1;
                    }

                    break;
                case 1:
                    if(this.tbGr[i].gaucheT() && this.tbGr[j].gaucheT()){
                        this.tbGr[j].gauche();
                        this.tbGr[j].haut();
                        this.rotation = 2;
                    }

                    break;

                case 2:
                    if(this.tbGr[i].hautT() && this.tbGr[j].hautT()){
                        this.tbGr[j].haut();
                        this.tbGr[j].droite();
                        this.rotation = 3;
                    }
                    break;
                case 3:
                    if(this.tbGr[i].droiteT() && this.tbGr[j].droiteT()){
                        this.tbGr[j].droite();
                        this.tbGr[j].bas();
                        this.rotation = 0;
                    }
                    break;
            }

        }

        this.enBas = function(i,j){
            this.tbGr[j].fall();
            this.tbGr[i].fall();

        }
    }

    function newPuyoColor(){;
        return tabColor[Math.floor(Math.random()*5)];
    }

    // initialisation (appelée au chargement du corps du document <body onload="init">)
    function init() {
        // instanciation de la variable globale contenant le ctxe
        ctx = document.getElementById("cvs").getContext("2d");
        ctx.width = document.getElementById("cvs").width;
        ctx.height = document.getElementById("cvs").height;

        // on associe au document des écouteurs d'événements
        document.addEventListener("keydown", captureAppuiToucheClavier) // 2 écouteurs pour le clavier (appui/relâchement d'une touche)
        document.addEventListener("keyup", captureRelacheToucheClavier) // on associe au document un écouteur d'événements souris
        document.addEventListener("click", captureClicSouris)
        // --> ces événements vont appeler les fonctions captureXYZ définies après.
        // initialisation du tableau
        initpuyo(puyo);
        timer = Date.now();
        // lancement de la boucle de jeu
        boucleDeJeu();
    }

    //initialisation de notre tableau de puyo puyo
    initpuyo = function(puyo) {
        for(var i=0;i<lgn; i++){
            puyo.push([]);
            for(var j=0; j<cln; j++){
                puyo[i].push("Vide");
            }
        }
        for(var i=0;i<cln; i++){
            puyo[0][i] = new Block();
            puyo[lgn-1][i] = new Block();
        }
        for(var i=0;i<lgn; i++){
            puyo[i][cln-1] = new Block();
        }
    }

    boucleDeJeu = function() {
        update(Date.now());
        render();
        requestAnimationFrame(boucleDeJeu);

    }


    update = function(d) {

        if (d > timer + 500){
            tomber = false;
            destroyCombo();
            lesPuyosDescendusDuCiel();
            if (tomber == false){
                leGroupe = new GroupeJoueur();
            }
            timer = Date.now();
        }
    }


    render = function() {
        ctx.clearRect(0, 0, ctx.width, ctx.height); // effacement de l'écran
        majAffichagePuyos();
    }

//     var fin = true;
//     function destroyCombo(fin){
//         var fin = true;
//         var grp = 0
//         var counter = 0
//         var counterTotal = 0
//         for(var i=0;i<lgn; i++){
//             for(var j=cln-1; j>=0; j--){
// // Pour i de 1 à 6 faire
// // Pour j de 1 à 12 faire
//                 if(puyo[i][j].type = puyo){
//                     grp ++
//                     counterTotal = testGroupe(puyos[i][j], grp, counter)
//                 }
//                 if(counterTotal >= 4){
//                     fin = false;
//                 }
//                 for(var u=0;u<lgn; u++){
//                     for(var v=cln-1; v>=0; v--){
//                         if(puyos[i][j].groupe = grp){
//
//                         }
// Puyos[i][j].couleur = N
// Puyos[i][j].groupe = 0
// Fin Si
// Fait
// Fait
// Fin Si
// counter = 1
// Fait
// Fait
// Si fin==faux alors
// destruction(puyo[][])
// chaine++
// Fin Si
// retourner chaine
// FinAction
// }

    function testGroupe(i,j){
        if (puyo[i][j].type == "puyo"){
            tempoGroupe = [puyo[i][j]];
            if(puyo[i][j].colorDroite()){
                tempoGroupe += testGroupe(i,j+1);
            }
            if(puyo[i][j].colorHaut()){
                tempoGroupe += testGroupe(i-1,j);
            }
            if(puyo[i][j].colorBas()){
                tempoGroupe += testGroupe(i+1,j);
            }
            if(puyo[i][j].colorGauche()){
                tempoGroupe += testGroupe(i,j-1);
            }
        }
        return tempoGroupe;

    }

    function destroyCombo(){
        for(var i=0;i<lgn; i++){
            for(var j=cln-1; j>=0; j--){
                    grp = testGroupe(i,j);
                    if ( grp.length >= 4){
                        destroy(grp);
                    }
                }
            }
        }
    }

    function lesPuyosDescendusDuCiel(){
         for(var i=0;i<lgn; i++){
             for(var j=cln-1; j>=0; j--){
                if(puyo[i][j].type == "Puyo"){
                    puyo[i][j].fall();
                }
            }
        }
    }

    function majAffichagePuyos(){
        for(var i=0;i<lgn; i++){
            for(var j=0; j<cln; j++){
                ctx.beginPath();
                switch (puyo[i][j].type) {
                    case "Block":
                        ctx.fillStyle = colorBlock;
                        ctx.fillRect (50*i,50*j, 50, 50);
                        break;

                    case "Puyo":
                        ctx.fillStyle = puyo[i][j].color;
                        ctx.arc(25+50*i,25+50*j,20,0,2*Math.PI);
                        break;

                    default:
                        ctx.fillStyle = "White";//puyo[i][j].couleur;
                        ctx.arc(25+50*i,25+50*j,20,0,2*Math.PI);

                }
                ctx.stroke();
                ctx.fill();
            }
        }
    }

    captureAppuiToucheClavier = function(event) {
        if (event.keyCode==37){
            leGroupe.go("gauche");
        }
        if (event.keyCode==38){
            leGroupe.pivoter(0,1);
        }
        if (event.keyCode==39){
            leGroupe.go("droite");
        }
        if (event.keyCode==40){
            leGroupe.go("bas");
        }
    }

    captureRelacheToucheClavier = function(event) {
    }

    captureClicSouris = function(event) {
        // calcul des coordonnées de la souris dans le canvas
    }

    </script>
</head>

<body onload="init()">

    <canvas id="cvs" width="400" height="700" style="margin: 10px auto; border: solid 1px #000;"></canvas>

</body>

</html>
