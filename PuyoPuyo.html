<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <title>PuyoPuyo</title>
    <script>
    var ctx = null;

    var clic = { x: 0, y: 0 };

    /**
    *Les constantes, les variables et les structures de PuyoPuyo
    */
    var needMajAffichage = true;

    var colorVide = "#FFFFFF";
    var colorBlock = "#B5351A";

    var cln = 14;
    var lgn = 8;
    var score = 0; //score du joueur
    var detection = true; //met fin à la destruction des puyos dans le jeu
    var chaine = 0; //compte le nombre de chaine pour le score
    var tabJeu = []; //tableau de jeu
    var speed = 10;
    var tabColor = ["#FF0000" /*rouge*/, "#00FF00" /*vert*/, "#0000FF" /*bleu*/, "#FF00FF" /*violet*/, "#FFFF00" /*jaune*/];
    var tabJeu = [];
    /**
    *objet puyo
    */
    function nouveauPuyo(){
      this.couleur = false;
      this.groupe = -1;
      this.check = false;
      this.position = {x:0, y:0};
    }

    function newPuyoColor(){;
      return tabColor[Math.floor(Math.random()*5)];
    }

    // initialisation (appelée au chargement du corps du document <body onload="init">)
    function init() {
        // instanciation de la variable globale contenant le ctxe
        ctx = document.getElementById("cvs").getContext("2d");
        ctx.width = document.getElementById("cvs").width;
        ctx.height = document.getElementById("cvs").height;

        // on associe au document des écouteurs d'événements
        document.addEventListener("keydown", captureAppuiToucheClavier) // 2 écouteurs pour le clavier (appui/relâchement d'une touche)
        document.addEventListener("keyup", captureRelacheToucheClavier) // on associe au document un écouteur d'événements souris
        document.addEventListener("click", captureClicSouris)
        // --> ces événements vont appeler les fonctions captureXYZ définies après.
        // initialisation du tableau
        inittabJeu(tabJeu);

        // lancement de la boucle de jeu
        boucleDeJeu();
    }

    //initialisation de notre tableau de puyo tabJeu
    inittabJeu = function(tabJeu) {


        for(var i=0;i<lgn; i++){
            tabJeu.push([]);
            for(var j=0; j<cln; j++){
                tabJeu[i].push(new nouveauPuyo);
                tabJeu[i][j].couleur = colorVide;
            }
        }

        for(var i=0;i<cln; i++){
            tabJeu[0][i].couleur = colorBlock;
            tabJeu[lgn-1][i].couleur = colorBlock;
        }
        for(var i=0;i<lgn; i++){
            tabJeu[i][cln-1].couleur = colorBlock;
        }

        tabJeu[3][1].couleur = newPuyoColor();

    }

    boucleDeJeu = function() {

        update(Date.now());
        render();
        requestAnimationFrame(boucleDeJeu);
    }


    update = function(d) {
        lePuyoTombeDuCiel();
    }


    render = function() {
        ctx.clearRect(0, 0, ctx.width, ctx.height); // effacement de l'écran
        majAffichagePuyos();

    }

    function majAffichagePuyos(){
        for(var i=0;i<lgn; i++){
            for(var j=0; j<cln; j++){
                if(tabJeu[i][j].couleur == colorBlock){
                    ctx.fillStyle = tabJeu[i][j].couleur;
                    ctx.fillRect (50*i,50+50*j, 50, 50);
                }else{
                    ctx.beginPath();
                    ctx.arc(25+50*i,75+50*j,20,0,2*Math.PI);
                    ctx.fillStyle = tabJeu[i][j].couleur;
                    ctx.stroke();
                    ctx.fill();
                }

            }
        }
    }

    function lePuyoTombeDuCiel(){
        for(var i=0;i<lgn; i++){
            for(var j=1; j<cln-1; j++){
                if((tabJeu[i][j].couleur !== colorVide)
                && (tabJeu[i][j].couleur !== colorBlock)
                && (tabJeu[i][j+1].couleur == colorVide)){

                    tabJeu[i][j+1].couleur = tabJeu[i][j].couleur;
                    tabJeu[i][j].couleur = colorVide;
                }
            }
        }
    }

    captureAppuiToucheClavier = function(event) {
    }

    captureRelacheToucheClavier = function(event) {
    }

    captureClicSouris = function(event) {
        // calcul des coordonnées de la souris dans le canvas
    }

    </script>
</head>

<body onload="init()">

    <canvas id="cvs" width="400" height="750" style="margin: 10px auto; border: solid 1px #000;"></canvas>

</body>

</html>
